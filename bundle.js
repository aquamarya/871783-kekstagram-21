(()=>{"use strict";(()=>{const e=(e,t)=>(e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e);window.util={ESC_KEY:"Escape",getRandomIntInclusive:e,getRandomArrayElement:t=>t[e(0,t.length-1)],shufflePhotos:e=>{for(let t=e.length-1;t>0;t--){let r=Math.floor(Math.random()*(t+1));[e[t],e[r]]=[e[r],e[t]]}return e},debounce:e=>{let t=null;return(...r)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...r)}),500)}}}})(),(()=>{const e=document.querySelector(".img-filters");e.classList.remove("img-filters--inactive");const t=()=>window.gallery.usersPhotos,r=window.util.debounce((r=>{var o;o=r.target,e.querySelector(".img-filters__button--active").classList.remove("img-filters__button--active"),o.classList.add("img-filters__button--active"),window.gallery.removePhotos();let n=[];switch(r.target.id){case"filter-default":n=t();break;case"filter-random":n=window.util.shufflePhotos(window.gallery.usersPhotos.slice().splice(0,10));break;case"filter-discussed":n=window.gallery.usersPhotos.slice().sort(((e,t)=>t.comments.length-e.comments.length));break;default:n=t()}window.gallery.createPicturesList(n)}));e.addEventListener("click",r)})(),(()=>{const e="https://21.javascript.pages.academy/kekstagram/data",t="https://21.javascript.pages.academy/kekstagram",r=document.querySelector("main"),o=(e,t,r)=>(e.responseType="json",e.addEventListener("load",(function(){let o;switch(e.status){case 200:t(e.response);break;case 400:o="Неверный запрос";break;case 404:o="Пользователь не авторизован";break;case 500:o="Ничего не найдено";break;default:o=`Статус ответа: ${e.status} ${e.statusText}`}o&&r(o)})),e.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),e.addEventListener("timeout",(()=>{r(`Запрос не успел выполниться за ${e.TIMEOUT}мс`)})),e.TIMEOUT=1e4,e),n=(e,t)=>{r.appendChild(e);const o=r.querySelector(`.${t}__button`);r.querySelector("."+t).style.zIndex=100;const n=()=>{r.removeChild(e),document.removeEventListener("keydown",c),document.removeEventListener("mouseup",s)};o.addEventListener("click",(()=>{n()}));const c=e=>{e.key===window.util.ESC_KEY&&n()},s=e=>{e.target.closest(`.${t}__inner`)||n()};document.addEventListener("keydown",c),document.addEventListener("keydown",s)};window.backend={load:(t,r)=>{const n=new XMLHttpRequest;n.open("GET",e),o(n,t,r),n.send()},send:function(e,r,n){const c=new XMLHttpRequest;c.open("POST",t),o(c,r,n),c.send(e)},loadErrorHandler:e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: #ff4e4e; border: 2px solid white;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="24px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},errorHandler:()=>{const e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);e.querySelector("h2").textContent="Ошибка загрузки файла",e.querySelector("button").textContent="Загрузить другой файл",n(e,"error")},successHandler:()=>{const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);e.querySelector("h2").textContent="Изображение успешно загружено",e.querySelector("button").textContent="Круто!",n(e,"success")}}})(),(()=>{const e=document.querySelector(".pictures"),t=document.querySelector("#picture").content.querySelector(".picture"),r=document.querySelector(".social__comments"),o=document.querySelector(".social__comment"),n=e=>{const r=t.cloneNode(!0);return r.querySelector(".picture__img").src=e.url,r.querySelector(".picture__comments").textContent=e.comments.length,r.querySelector(".picture__likes").textContent=e.likes,r},c=t=>{const r=document.createDocumentFragment();for(let e of t){const t=n(e);r.appendChild(t),t.addEventListener("click",(()=>{window.preview.showBigPicture(e)}))}e.appendChild(r)};window.backend.load((e=>{c(e),window.gallery.usersPhotos=e}),window.backend.loadErrorHandler);const s=e=>{const t=o.cloneNode(!0);return t.querySelector(".social__picture").src=e.avatar,t.querySelector(".social__picture").alt=e.name,t.querySelector(".social__text").textContent=e.message,t},l=e=>{const t=document.createDocumentFragment();for(let r of e)t.appendChild(s(r));return t};window.gallery={createCommentsFragment:l,createPicturesList:c,usersPhotos:[],renderLimitedComments:e=>{r.appendChild(l(e))},removePhotos:()=>{document.querySelectorAll(".picture").forEach((e=>{e.remove()}))},CommentsAmount:{MIN:0,MAX:5}}})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector("#picture-cancel"),r=document.querySelector(".comments-loader"),o=document.querySelector(".social__comments"),n=document.querySelector(".comments-count"),c=document.querySelector(".current-comments-count");let s=0,l=[];const i=()=>m(),a=e=>{e.key===window.util.ESC_KEY&&m()},d=()=>{s+=5,window.gallery.renderLimitedComments(l.slice(s-5,s)),c.innerText=Math.min(s,l.length),s>=l.length&&(r.removeEventListener("click",u),r.classList.add("hidden"))},u=()=>d(),m=()=>{document.querySelector("body").classList.remove("modal-open"),e.classList.add("hidden"),document.removeEventListener("keydown",a),t.removeEventListener("click",i)};window.preview={showBigPicture:c=>{var m;m=c,e.querySelector(".big-picture__img img").src=m.url,e.querySelector(".likes-count").textContent=m.likes,e.querySelector(".social__caption").textContent=m.description,e.querySelector(".comments-count").textContent=m.comments.length,e.querySelector(".social__comment-count ").classList.remove("hidden"),e.querySelector(".comments-loader").classList.add("hidden"),o.innerHTML="",document.querySelector("body").classList.add("modal-open"),e.classList.remove("hidden"),document.addEventListener("keydown",a),t.addEventListener("click",i),c.comments.length>window.gallery.CommentsAmount.MAX&&(r.classList.remove("hidden"),r.addEventListener("click",u)),l=c.comments.slice(),s=0,n.innerText=l.length,d()}}})(),(()=>{const e={MIN:0,MAX:1},t={MIN:0,MAX:1},r={MIN:0,MAX:100},o={MIN:0,MAX:3},n={MIN:1,MAX:3},c=document.querySelector(".img-upload__preview img"),s=document.querySelector(".effect-level"),l=s.querySelector(".effect-level__value"),i=s.querySelector(".effect-level__pin"),a=s.querySelector(".effect-level__depth"),d=()=>{Array.from(c.classList).forEach((e=>{e.match("effects__preview--")&&c.classList.remove(e)}))},u=(e,t=!0)=>{t?(s.classList.contains("hidden")&&s.classList.remove("hidden"),f()):s.classList.add("hidden"),d(),c.classList.add(e)},m=e=>{switch(e.target.id){case"effect-none":u("effects__preview--none");break;case"effect-chrome":u("effects__preview--chrome");break;case"effect-sepia":u("effects__preview--sepia");break;case"effect-marvin":u("effects__preview--marvin");break;case"effect-phobos":u("effects__preview--phobos");break;case"effect-heat":u("effects__preview--heat")}};document.querySelectorAll(".effects__radio").forEach((e=>{e.addEventListener("click",m)}));const f=()=>{i.style.left="100%",a.style.width="100%",l.value=100,c.style.filter=""},v=e=>l.value*(e.MAX-e.MIN)/100+e.MIN,w=document.querySelector(".scale").querySelector(".scale__control--value"),y=()=>parseInt(w.value,10),p=e=>{const t=(r=e,Math.min(100,Math.max(25,r)));var r;w.value=t+"%",c.style.transform=`scale(${t/100})`};window.editor={editPhotoItemChangeHandler:e=>{if(e.target.matches('input[type="radio"]')){c.style.filter="";const t=e.target.value;c.classList.remove("effects__preview--"+t),e.target.matches('input[value="none"]')?s.classList.add("hidden"):(s.classList.remove("hidden"),c.classList.add("effects__preview--"+t),f())}},setDefaultDepthLevel:f,createNewDepthLevel:()=>{const s=Array.from(c.classList);for(let l of s)if(l.match("effects__preview--"))switch(l){case"effects__preview--chrome":c.style.filter=`grayscale(${v(e)})`;break;case"effects__preview--sepia":c.style.filter=`sepia(${v(t)})`;break;case"effects__preview--marvin":c.style.filter=`invert(${v(r)}%)`;break;case"effects__preview--phobos":c.style.filter=`blur(${v(o)}px)`;break;case"effects__preview--heat":c.style.filter=`brightness(${v(n)})`;break;default:c.style.filter=""}},removeEffect:d,biggerButtonClickHandler:()=>{p(y()+25)},smallerButtonClickHandler:()=>{p(y()-25)}}})(),(()=>{const e=(e,t)=>{const r=e.indexOf(t)+1;return e.indexOf(t,r)};window.validation={hashtagInputHandler:t=>{const r=t.target.value.toLowerCase().split(" ");t.target.setCustomValidity((t=>{if(t.length>5)return"нельзя указать больше 5 хэш-тегов";for(let r of t){if("#"!==r[0])return"хэш-тег начинается с символа # (решётка)";if(r.length<2)return"хеш-тег не может состоять только из одной решётки";if(!r.match(/^#[a-zA-Z0-9а-яА-Я]+$/))return"строка после решётки должна состоять из букв и чисел и не может содержать пробелы, спецсимволы (#, @, $ и т. п.), символы пунктуации (тире, дефис, запятая и т. п.), эмодзи и т. д.";if(r.length>20)return"максимальная длина одного хэш-тега 20 символов, включая решётку";if(-1!==e(t,r))return"один и тот же хэш-тег не может быть использован дважды"}return""})(r)),t.target.style.border="2px solid red"}}})(),(()=>{const e=document.querySelector(".img-upload__form"),t=e.querySelector("#upload-file"),r=e.querySelector(".img-upload__overlay"),o=e.querySelector(".text__description"),n=document.querySelector(".effect-level"),c=e.querySelector(".img-upload__preview img"),s=document.querySelector("#upload-cancel"),l=e.querySelector(".scale"),i=l.querySelector(".scale__control--smaller"),a=l.querySelector(".scale__control--bigger"),d=l.querySelector(".scale__control--value"),u=e.querySelector(".text__hashtags"),m=e=>{u!==document.activeElement&&o!==document.activeElement&&e.key===window.util.ESC_KEY&&f()},f=()=>{r.classList.add("hidden"),document.removeEventListener("keydown",m),t.value="",c.style.filter="",c.style.transform="",d.value="100%",document.querySelector("body").classList.remove("modal-open"),r.removeEventListener("change",window.editor.editPhotoItemChangeHandler),i.removeEventListener("click",window.editor.smallerButtonClickHandler),a.removeEventListener("click",window.editor.biggerButtonClickHandler),u.removeEventListener("input",window.validation.hashtagInputHandler),e.removeEventListener("submit",w),v()},v=()=>{e.reset()};t.addEventListener("change",(t=>{t.preventDefault(),r.classList.remove("hidden"),document.addEventListener("keydown",m),document.querySelector("body").classList.add("modal-open"),r.addEventListener("change",window.editor.editPhotoItemChangeHandler),n.classList.add("hidden"),window.editor.removeEffect(),window.editor.setDefaultDepthLevel(),i.addEventListener("click",window.editor.smallerButtonClickHandler),a.addEventListener("click",window.editor.biggerButtonClickHandler),u.addEventListener("input",window.validation.hashtagInputHandler),e.addEventListener("submit",w),window.uploadPhoto.fileUploadHandler()})),s.addEventListener("click",(e=>{e.preventDefault(),f()}));const w=t=>{t.preventDefault(),window.backend.send(new FormData(e),window.backend.successHandler,window.backend.errorHandler),f()}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector("#upload-file"),r=document.querySelector(".img-upload__preview img"),o=document.querySelectorAll(".effects__preview");window.uploadPhoto={fileUploadHandler:()=>{const n=t.files[0],c=n.name.toLowerCase();if(e.some((function(e){return c.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){r.src=e.result,o.forEach((t=>{t.style.backgroundImage=`url(" ${e.result} ")`}))})),e.readAsDataURL(n)}}}})(),(()=>{const e=document.querySelector(".effect-level"),t=e.querySelector(".effect-level__value"),r=e.querySelector(".effect-level__pin"),o=e.querySelector(".effect-level__line"),n=e.querySelector(".effect-level__depth");e.addEventListener("mousedown",(e=>{e.preventDefault();const c=o.offsetWidth;let s=e.clientX;const l=e=>{e.preventDefault();const l=s-e.clientX,i=r.offsetLeft-l;if(s=e.clientX,!(i<0||i>c)){const e=i/o.offsetWidth;r.style.left=i+"px",t.value=Math.round(100*e),n.style.width=100*e+"%",window.editor.createNewDepthLevel(t.value)}},i=e=>{e.preventDefault(),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",l),document.addEventListener("mouseup",i)}))})()})();